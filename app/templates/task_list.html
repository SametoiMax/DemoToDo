{% macro render_task(task, current_task_id, hidden=False, completed_filter=None) %}
    {% if completed_filter is not none %}
        {% if completed_filter == 'completed' and task['completed_at'] is none %}
            {% set ns = namespace(OutOk=0) %}  {# –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ #}
        {% elif completed_filter == 'not_completed' and task['completed_at'] is not none %}
            {% set ns = namespace(OutOk=0) %}  {# –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ #}
        {% else %}
            {% set ns = namespace(OutOk=1) %}  {# –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–≤–æ–¥–∏—Ç—å –∑–∞–¥–∞—á—É #}
        {% endif %}
    {% else %}
        {% set ns = namespace(OutOk=1) %}  {# –ï—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –≤—ã–≤–æ–¥–∏–º –≤—Å–µ –∑–∞–¥–∞—á–∏ #}
    {% endif %}

    {% if ns.OutOk == 1 %}  {# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–¥–∞—á–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∞ #}
    <li class="task
        {% if current_task_id is defined and task['id']|int == current_task_id|int %} current-task{% endif %}
        {% if task['subtasks'] %} top-level-task{% endif %}
        {% if not task['subtasks'] %} down-level-task{% endif %}
        {% if hidden %} hidden-task{% endif %}"
        data-task-id="{{ task.id }}"
        data-completed="{{ task['completed_at'] is not none }}"
        data-priority="{{ task['priority']|default(1) }}"
        {% if task['started_at'] or task['completed_at'] %}
            data-tooltip="
                {% if task['started_at'] %}<strong>–ù–∞—á–∞–ª–æ:</strong> {{ task['started_at'] }}<br>{% endif %}
                {% if task['completed_at'] %}<strong>–û–∫–æ–Ω—á–∞–Ω–∏–µ:</strong> {{ task['completed_at'] }}{% endif %}
            "
        {% endif %}
    >
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥—Ä–æ–ø-–∑–æ–Ω—ã -->
        <div class="droppable-area" data-task-id="{{ task.id }}">
            <!-- –ó–≤—ë–∑–¥–æ—á–∫–∞ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –ø–µ—Ä–µ–Ω–æ—Å–∞ (jQuery UI) -->
            <span class="priority-star draggable-task {% if task['completed_at'] %}done{% endif %}"
                data-task-id="{{ task.id }}"
                data-priority="{{ task['priority']|default(1) }}">
                ‚òÖ
            </span>

            {% if task['subtasks'] %}
                <span class="toggle-subtasks" data-task-id="{{ task['id'] }}">‚ñº</span>
            {% endif %}

            <!-- –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å (FullCalendar) -->
            <span class="task-text tooltip-trigger">
                {% if current_task_id is defined and task['id']|int == current_task_id|int %}üéØ{% else %}‚ñ™{% endif %}
                <a href="/edit/{{ task['id'] }}"
                   class="task-link fc-draggable {% if task['completed_at'] %}done{% endif %}"
                   data-task-id="{{ task.id }}"
                   data-parent-id="{{ task.parent_id }}"
                   data-event='{"id":"{{ task.id }}","title":"{{ task.content|replace('"','\\"') }}"}'>
                    {{ task['content'] }}
                </a>
            </span>

            <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
            {% if (not task['subtasks'] or task['all_subtasks_done']) and not task['parent_done'] %}
                <a href="/done/{{ task['id'] }}" class="done-button" draggable="false">‚úî</a>
            {% endif %}

            <!-- –ö–Ω–æ–ø–∫–∞ "–°–¥–µ–ª–∞—Ç—å —Ç–µ–∫—É—â–µ–π" -->
            {% if not task['completed_at'] and not task['subtasks'] and not task['parent_done'] and task['id'] != current_task_id %}
                <a href="#" onclick="setCurrentTask({{ task['id'] }})" title="–°–¥–µ–ª–∞—Ç—å —Ç–µ–∫—É—â–µ–π" class="set-current" draggable="false">üéØ</a>
            {% endif %}
        </div>

        <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–¥–∞—á–µ -->
        {% if task['comment'] %}
            <div class="task-comment {% if task['completed_at'] %}done{% endif %}">{{ task['comment'] }}</div>
        {% endif %}

        <!-- –ü–æ–¥–∑–∞–¥–∞—á–∏ –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ -->
        {% if task['subtasks'] %}
            <ul class="subtasks {% if hidden %}hidden-task{% endif %} not-completed-subtasks">
                {% set ns = namespace(completed_count=0) %}
                {% for subtask in task['subtasks'] %}
                    <li class="task
                        {% if subtask['completed_at'] is not none %}done{% endif %}
                        {% if subtask_hidden %}hidden-task{% endif %}"
                        data-task-id="{{ subtask.id }}">
                        {{ render_task(subtask, current_task_id, subtask_hidden, 'not_completed') }}
                    </li>
                {% endfor %}
            </ul>
        {% endif %}

        <!-- –ü–æ–¥–∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ -->
        {% if task['subtasks'] %}
            <ul class="subtasks {% if hidden %}hidden-task{% endif %} completed-subtasks">
                {% set ns = namespace(completed_count=0) %}
                {% for subtask in task['subtasks'] %}
                    {% if subtask['completed_at'] is not none %}
                        {% set ns.completed_count = ns.completed_count + 1 %}
                    {% endif %}
                    {% set subtask_hidden = ns.completed_count > 5 and subtask['completed_at'] is not none %}
                    <li class="task
                        {% if subtask['completed_at'] is not none %}done{% endif %}
                        {% if subtask_hidden %}hidden-task{% endif %}"
                        data-task-id="{{ subtask.id }}">
                        {{ render_task(subtask, current_task_id, subtask_hidden, 'completed') }}
                    </li>
                {% endfor %}
                {% if ns.completed_count > 5 %}
                    <li class="toggle-more">
                        <a href="#" onclick="toggleCompletedTasks(this)" draggable="false">–µ—â–µ..</a>
                    </li>
                {% endif %}
            </ul>
        {% endif %}
    </li>

    {% endif %}
{% endmacro %}
